<!DOCTYPE html>
<html lang="es" class="light dark">

<head>

 <meta charset="UTF-8">
 <title>Cámara - PWA</title>

 <script src="js/registraServiceWorker.js"></script>

 <meta name="viewport" content="width=device-width">
 <meta name="theme-color" content="#fffbfe">
 <link rel="icon" sizes="32x32" href="favicon.ico">
 <link rel="manifest" href="site.webmanifest">
 <script src="ungap/custom-elements.js"></script>

 <script type="module" src="js/configura.js"></script>
 <link rel="stylesheet" href="css/estilos.css">
 <link rel="stylesheet" href="css/transicion_pestanas.css">
 <link rel="expect" blocking="render" href="#navtabfixed">

</head>

<body>

 <md-top-app-bar adicional="tab" headline="headline">

  <h1>Cámara</h1>

  <!--<button type="button" class="md-standard-icon-button" title="Agregar"
    slot="action">
   <span class="material-symbols-outlined">add</span>
  </button>
  <button type="button" class="md-standard-icon-button" title="Editar"
    slot="action">
   <span class="material-symbols-outlined">edit</span>
  </button>-->

 </md-top-app-bar>

 <h1 id="headline">PWA - Cámara</h1>

 <nav-tab-fixed id="tab"></nav-tab-fixed>

 <main>
  <p>
  Para grabar o capturar imagen,
  cliquea
  <strong>Inicia</strong>.
 </p>
 <p>
  Para grabar por 5 segundos
  cliquea
  <strong>Graba</strong>
  y cliquea
  <strong>Para</strong> para
  detener.
 </p>
 <p>
  Para capturar una imagen de la
  cámara, cliquea
  <strong>Captura</strong>.
 </p>

  <p style="justify-content: center; display: flex;">

   <button class="md-filled-button" type="button" onclick="inicia()">
    Inicia
   </button>

   <button class="md-filled-button" type="button" onclick="graba()">
    Graba
   </button>

   <button class="md-filled-button" type="button" onclick="para()">
    Para
   </button>

   <button class="md-filled-button" type="button" onclick="captura()">
    Captura
   </button>

  </p>
  
   <div class="md-cards">

    <div class="card">
      <figure>
        <video id="preview" width="160" height="120" autoplay muted></video>
      </figure>
      <span class="headline">Preview</span>
      <span class="supporting">Vista en vivo de la cámara.</span>
    </div>

    <div class="card">
      <figure>
        <video id="recording" width="160" height="120" controls></video>
      </figure>
      <span class="headline">Recording</span>
      <span class="supporting">
        <a id="descarga">Descarga Video</a>
        <div id="mensajes"></div>
      </span>
    </div>

    <div class="card">
      <figure>
        <canvas id="canvas" width="160" height="120"></canvas>
      </figure>
      <span class="headline">Imagen</span>
      <span class="supporting">
        <a id="descargaImagen">Descarga Imagen</a>
      </span>
    </div>

  </div>
 </main>

 <script>
  let stream = null
  let TIEMPO_DE_GRABACION = 5000
  var context =
   canvas.getContext('2d')
  async function inicia() {
   try {
    stream = await navigator
     .mediaDevices.getUserMedia({
      video: true,
      audio: true
     })
    preview.srcObject = stream
    descarga.href = stream
    preview.captureStream =
     preview.captureStream
     || preview.mozCaptureStream
    await new Promise(
     resolve =>
      preview.onplaying = resolve)
   } catch (e) {
    log(e.message)
   }
  }
  async function graba() {
   try {
    const recordedChunks =
     await grabaClip(stream,
      TIEMPO_DE_GRABACION)
    let recordedBlob = new Blob(
     recordedChunks,
     { type: "video/webm" })
    recording.src =
     URL.createObjectURL(
      recordedBlob)
    descarga.href = recording.src
    descarga.download =
     "RecordedVideo.webm"
    log("Exitosamente grabados "
     + recordedBlob.size
     + " bytes de "
     + recordedBlob.type
     + " media.")
   } catch (e) {
    log(e.message)
   }
  }
  function para() {
   detiene(preview.srcObject)
  }
  function captura() {
   context.drawImage(preview,
    0, 0, 160, 120)
   descargaImagen.href =
    canvas.toDataURL('image/jpeg')
   descargaImagen.download =
    "imagen.jpg"
  }
  function grabaClip(stream,
   milisegundos) {
   let recorder =
    new MediaRecorder(stream)
   let data = []
   recorder.ondataavailable =
    event => data.push(event.data)
   recorder.start()
   log(recorder.state
    + " durante "
    + (milisegundos / 1000)
    + " segundos…")
   let detenido = new Promise(
    (resolve, reject) => {
     recorder.onstop = resolve
     recorder.onerror =
      event => reject(event.name)
    })
   let grabado =
    espera(milisegundos)
     .then(() => recorder.state
      === "recording"
      && recorder.stop()
     )
   return Promise.all([
    detenido,
    grabado
   ])
    .then(() => data)
  }
  function detiene(stream) {
   stream.getTracks().forEach(
    track => track.stop())
  }
  function log(msg) {
   mensajes.innerHTML +=
    msg + "<br>"
  }
  function espera(milisegundos) {
   return new Promise(
    resolve => setTimeout(
     resolve, milisegundos))
  }
 </script>

</body>

</html>